#!/bin/sh

echo "seting up $1"
# get deps
apk add curl jq mysql-client
# get the wait-until script
curl -L https://raw.githubusercontent.com/nickjj/wait-until/v0.2.0/wait-until -o /usr/local/bin/wait-until && \
chmod +x /usr/local/bin/wait-until
# run the script and everything else
wait-until "echo 'Checking if Metabase is ready' && curl -s http://$1/api/health | grep -ioE 'ok'" 60 && \
wait-until "echo 'Checking if MariaDB is ready' && mysql --user=metabase --password=metasample123 --port=3306 --host=mariadb-data" 60 && \
echo "Both servers are ready, let's configure"
if curl -s http://$1/api/session/properties | jq -r '."setup-token"' | grep -ioE "null"; then echo 'Instance already configured, exiting (or <v43)'; else \
echo 'Setting up the instance' && \
token=$(curl -s http://$1/api/session/properties | jq -r '."setup-token"') && \
echo 'Setup token fetched, now configuring with:' && \
echo "{'token':'$token','user':{'first_name':'a','last_name':'b','email':'a@b.com','site_name':'metabot1','password':'metabot1','password_confirm':'metabot1'},'database':null,'invite':null,'prefs':{'site_name':'metabot1','site_locale':'en','allow_tracking':'false'}}" > file.json && \
sed 's/'\''/\"/g' file.json > file2.json && \
cat file2.json && \
sessionToken=$(curl -s http://$1/api/setup -H 'Content-Type: application/json' --data-binary @file2.json | jq -r '.id') && echo ' < Admin session token, exiting' && \
# creating a postgres
curl -s -X POST http://$1/api/database -H 'Content-Type: application/json' --cookie "metabase.SESSION=$sessionToken" --data '{"engine":"mysql","name":"mariadb","details":{"host":"mariadb-data","port":3306,"dbname":"sample","user":"metabase","password":"metasample123","ssl":false,"tunnel-enabled":false,"advanced-options":false},"is_full_sync":true}' && \
# wiping the sample database, nobody needs it
curl -s -X DELETE http://$1/api/database/1 -H 'Content-Type: application/json' --cookie "metabase.SESSION=$sessionToken" && \
# creating 10 questions
curl -s -X POST http://$1/api/card -H 'Content-Type: application/json' --cookie "metabase.SESSION=$sessionToken" --data '{"name":"Orders, Count, Grouped by Discount and Created At (month)","dataset_query":{"database":2,"query":{"source-table":6,"aggregation":[["count"]],"breakout":[["field",38,{"binning":{"strategy":"default"}}],["field",39,{"temporal-unit":"month"}]]},"type":"query"},"display":"line","description":null,"visualization_settings":{"graph.dimensions":["CREATED_AT","DISCOUNT"],"graph.metrics":["count"]},"collection_id":null,"result_metadata":[{"description":"Discount amount.","semantic_type":"type/Discount","coercion_strategy":null,"name":"DISCOUNT","settings":null,"field_ref":["field",38,{"binning":{"strategy":"num-bins","min-value":0,"max-value":70,"num-bins":8,"bin-width":10}}],"effective_type":"type/Float","id":38,"display_name":"Discount","fingerprint":{"global":{"distinct-count":701,"nil%":0.898},"type":{"type/Number":{"min":0.17088996672584322,"q1":2.9786226681458743,"q3":7.338187788658235,"max":61.69684269960571,"sd":3.053663125001991,"avg":5.161255547580326}}},"base_type":"type/Float"},{"description":"The date and time an order was submitted.","semantic_type":"type/CreationTimestamp","coercion_strategy":null,"unit":"month","name":"CREATED_AT","settings":null,"field_ref":["field",39,{"temporal-unit":"month"}],"effective_type":"type/Date","id":39,"display_name":"Created At","fingerprint":{"global":{"distinct-count":9999,"nil%":0},"type":{"type/DateTime":{"earliest":"2016-04-30T18:56:13Z","latest":"2020-04-19T14:07:15Z"}}},"base_type":"type/Date"},{"display_name":"Count","semantic_type":"type/Quantity","field_ref":["aggregation",0],"name":"count","base_type":"type/BigInteger","effective_type":"type/BigInteger","fingerprint":{"global":{"distinct-count":77,"nil%":0},"type":{"type/Number":{"min":1,"q1":37.51419081505237,"q3":388.4721935853075,"max":524,"sd":190.79715693142927,"avg":185.74257425742573}}}}]}' && \
curl -s -X POST http://$1/api/card -H 'Content-Type: application/json' --cookie "metabase.SESSION=$sessionToken" --data '{"name":"Orders, Average of Quantity, Grouped by Product → Vendor and Product → Category","dataset_query":{"database":2,"query":{"source-table":6,"aggregation":[["avg",["field",41,null]]],"breakout":[["field",62,{"source-field":40}],["field",63,{"source-field":40}]]},"type":"query"},"display":"bar","description":null,"visualization_settings":{"graph.dimensions":["VENDOR","CATEGORY"],"graph.metrics":["avg"]},"collection_id":null,"result_metadata":[{"description":"The source of the product.","semantic_type":"type/Company","coercion_strategy":null,"name":"VENDOR","settings":null,"field_ref":["field",62,{"source-field":40}],"effective_type":"type/Text","id":62,"display_name":"Product → Vendor","fingerprint":{"global":{"distinct-count":200,"nil%":0},"type":{"type/Text":{"percent-json":0,"percent-url":0,"percent-email":0,"percent-state":0,"average-length":20.6}}},"base_type":"type/Text"},{"description":"The type of product, valid values include: Doohicky, Gadget, Gizmo and Widget","semantic_type":"type/Category","coercion_strategy":null,"name":"CATEGORY","settings":null,"field_ref":["field",63,{"source-field":40}],"effective_type":"type/Text","id":63,"display_name":"Product → Category","fingerprint":{"global":{"distinct-count":4,"nil%":0},"type":{"type/Text":{"percent-json":0,"percent-url":0,"percent-email":0,"percent-state":0,"average-length":6.375}}},"base_type":"type/Text"},{"display_name":"Average of Quantity","semantic_type":"type/Quantity","settings":null,"field_ref":["aggregation",0],"name":"avg","base_type":"type/Decimal","effective_type":"type/Decimal","fingerprint":{"global":{"distinct-count":198,"nil%":0},"type":{"type/Number":{"min":2.9318,"q1":3.3521262993644534,"q3":3.9080789090385752,"max":5.6591,"sd":0.48717515610655254,"avg":3.7087630000000003}}}}]}' && \
curl -s -X POST http://$1/api/card -H 'Content-Type: application/json' --cookie "metabase.SESSION=$sessionToken" --data '{"name":"Orders, Sum of ,Discount, Sum of ,Total, Sum of ,Tax, and Sum of Subtotal, Grouped by Product → Category and Product → Vendor","dataset_query":{"type":"query","query":{"source-table":6,"aggregation":[["sum",["field",38,null]],["sum",["field",43,null]],["sum",["field",44,null]],["sum",["field",42,null]]],"breakout":[["field",63,{"source-field":40}],["field",62,{"source-field":40}]]},"database":2},"display":"pivot","description":null,"visualization_settings":{"pivot_table.column_split":{"rows":[["field",62,{"source-field":40}]],"columns":[["field",63,{"source-field":40}]],"values":[["aggregation",0],["aggregation",1],["aggregation",2],["aggregation",3]]}},"collection_id":null,"result_metadata":[{"description":"The type of product, valid values include: Doohicky, Gadget, Gizmo and Widget","semantic_type":null,"coercion_strategy":null,"name":"pivot-grouping","settings":null,"field_ref":["expression","pivot-grouping"],"effective_type":"type/Text","id":63,"display_name":"pivot-grouping","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":3,"q1":3,"q3":3,"max":3,"sd":null,"avg":3}}},"base_type":"type/BigInteger"},{"description":"The source of the product.","semantic_type":"type/Discount","coercion_strategy":null,"name":"sum","settings":null,"field_ref":["aggregation",0],"effective_type":"type/Text","id":62,"display_name":"Sum of Discount","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":9954.822827272115,"q1":9954.822827272115,"q3":9954.822827272115,"max":9954.822827272115,"sd":null,"avg":9954.822827272115}}},"base_type":"type/Float"},{"display_name":"Sum of Total","field_ref":["aggregation",1],"name":"sum_2","base_type":"type/Float","effective_type":"type/BigInteger","semantic_type":null,"fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":1595328.1251600615,"q1":1595328.1251600615,"q3":1595328.1251600615,"max":1595328.1251600615,"sd":null,"avg":1595328.1251600615}}}},{"display_name":"Sum of Tax","semantic_type":null,"settings":null,"field_ref":["aggregation",2],"name":"sum_3","base_type":"type/Float","effective_type":"type/Float","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":72388.33999999962,"q1":72388.33999999962,"q3":72388.33999999962,"max":72388.33999999962,"sd":null,"avg":72388.33999999962}}}},{"display_name":"Sum of Subtotal","semantic_type":null,"settings":null,"field_ref":["aggregation",3],"name":"sum_4","base_type":"type/Float","effective_type":"type/Float","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":1448188.1658779324,"q1":1448188.1658779324,"q3":1448188.1658779324,"max":1448188.1658779324,"sd":null,"avg":1448188.1658779324}}}}]}' && \
curl -s -X POST http://$1/api/card -H 'Content-Type: application/json' --cookie "metabase.SESSION=$sessionToken" --data '{"name":"Orders, Standard deviation of ,Quantity, Cumulative count, Maximum of ,Quantity, Minimum of ,Quantity, and Distinct values of Product → Category, Grouped by Created At (month)","dataset_query":{"database":2,"query":{"source-table":6,"aggregation":[["stddev",["field",41,null]],["cum-count"],["max",["field",41,null]],["min",["field",41,null]],["distinct",["field",63,{"source-field":40}]]],"breakout":[["field",39,{"temporal-unit":"month"}]]},"type":"query"},"display":"line","description":null,"visualization_settings":{"graph.dimensions":["CREATED_AT"],"graph.metrics":["stddev","count","max","min","count_2"]},"collection_id":null,"result_metadata":[{"description":"The date and time an order was submitted.","semantic_type":"type/CreationTimestamp","coercion_strategy":null,"unit":"month","name":"CREATED_AT","settings":null,"field_ref":["field",39,{"temporal-unit":"month"}],"effective_type":"type/Date","id":39,"display_name":"Created At","fingerprint":{"global":{"distinct-count":9999,"nil%":0},"type":{"type/DateTime":{"earliest":"2016-04-30T18:56:13Z","latest":"2020-04-19T14:07:15Z"}}},"base_type":"type/Date"},{"display_name":"SD of Quantity","semantic_type":"type/Quantity","settings":null,"field_ref":["aggregation",0],"name":"stddev","base_type":"type/Float","effective_type":"type/Float","fingerprint":{"global":{"distinct-count":49,"nil%":0},"type":{"type/Number":{"min":0,"q1":1.53625,"q3":5.006,"max":8.5785,"sd":2.1477805691272907,"avg":3.3580020408163267}}}},{"display_name":"Count","semantic_type":"type/Quantity","field_ref":["aggregation",1],"name":"count","base_type":"type/BigInteger","effective_type":"type/BigInteger","fingerprint":{"global":{"distinct-count":49,"nil%":0},"type":{"type/Number":{"min":1,"q1":1589.5,"q3":12551.25,"max":18760,"sd":6101.442216525421,"avg":7316.591836734694}}}},{"display_name":"Max of Quantity","semantic_type":"type/Quantity","settings":null,"field_ref":["aggregation",2],"name":"max","base_type":"type/Integer","effective_type":"type/Integer","fingerprint":{"global":{"distinct-count":38,"nil%":0},"type":{"type/Number":{"min":2,"q1":21.914213562373096,"q3":57.25,"max":100,"sd":24.565008158971576,"avg":40.6530612244898}}}},{"display_name":"Min of Quantity","semantic_type":"type/Quantity","settings":null,"field_ref":["aggregation",3],"name":"min","base_type":"type/Integer","effective_type":"type/Integer","fingerprint":{"global":{"distinct-count":4,"nil%":0},"type":{"type/Number":{"min":0,"q1":0.8877578289433403,"q3":2.034636212366874,"max":3,"sd":0.708908330045686,"avg":1.4489795918367347}}}},{"display_name":"Distinct values of Product → Category","semantic_type":"type/Quantity","settings":null,"field_ref":["aggregation",4],"name":"count_2","base_type":"type/BigInteger","effective_type":"type/BigInteger","fingerprint":{"global":{"distinct-count":2,"nil%":0},"type":{"type/Number":{"min":1,"q1":3.0584506470484634,"q3":4,"max":4,"sd":0.42857142857142855,"avg":3.938775510204082}}}}]}' && \
curl -s -X POST http://$1/api/card -H 'Content-Type: application/json' --cookie "metabase.SESSION=$sessionToken" --data '{"name":"Orders, Average of Product → Rating, Grouped by Product → Category and Product → Ean","dataset_query":{"database":2,"query":{"source-table":6,"aggregation":[["avg",["field",65,{"source-field":40}]]],"breakout":[["field",63,{"source-field":40}],["field",61,{"source-field":40}]]},"type":"query"},"display":"pivot","description":null,"visualization_settings":{"pivot_table.column_split":{"rows":[["field",61,{"source-field":40}]],"columns":[["field",63,{"source-field":40}]],"values":[["aggregation",0]]}},"collection_id":null,"result_metadata":[{"description":"The type of product, valid values include: Doohicky, Gadget, Gizmo and Widget","semantic_type":null,"coercion_strategy":null,"name":"pivot-grouping","settings":null,"field_ref":["expression","pivot-grouping"],"effective_type":"type/Text","id":63,"display_name":"pivot-grouping","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":3,"q1":3,"q3":3,"max":3,"sd":null,"avg":3}}},"base_type":"type/BigInteger"},{"description":"The international article number. A 13 digit number uniquely identifying the product.","semantic_type":"type/Score","coercion_strategy":null,"name":"avg","settings":null,"field_ref":["aggregation",0],"effective_type":"type/Text","id":61,"display_name":"Average of Product → Rating","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":3.4607142857142934,"q1":3.4607142857142934,"q3":3.4607142857142934,"max":3.4607142857142934,"sd":null,"avg":3.4607142857142934}}},"base_type":"type/Float"}]}' && \
curl -s -X POST http://$1/api/card -H 'Content-Type: application/json' --cookie "metabase.SESSION=$sessionToken" --data '{"name":"People, Count, Grouped by State and Source and Birth Date (month)","dataset_query":{"database":2,"query":{"source-table":8,"aggregation":[["count"]],"breakout":[["field",52,null],["field",53,null],["field",51,{"temporal-unit":"month"}]]},"type":"query"},"display":"pivot","description":null,"visualization_settings":{"pivot_table.column_split":{"rows":[["field",52,null],["field",51,{"temporal-unit":"month"}]],"columns":[["field",53,null]],"values":[["aggregation",0]]}},"collection_id":null,"result_metadata":[{"description":"The state or province of the accountu2019s billing address","semantic_type":null,"coercion_strategy":null,"name":"pivot-grouping","settings":null,"field_ref":["expression","pivot-grouping"],"effective_type":"type/Text","id":52,"display_name":"pivot-grouping","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":7,"q1":7,"q3":7,"max":7,"sd":null,"avg":7}}},"base_type":"type/BigInteger"},{"description":"The channel through which we acquired this user. Valid values include: Affiliate, Facebook, Google, Organic and Twitter","semantic_type":"type/Quantity","coercion_strategy":null,"name":"count","settings":null,"field_ref":["aggregation",0],"effective_type":"type/Text","id":53,"display_name":"Count","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":2500,"q1":2500,"q3":2500,"max":2500,"sd":null,"avg":2500}}},"base_type":"type/BigInteger"}]}' && \
curl -s -X POST http://$1/api/card -H 'Content-Type: application/json' --cookie "metabase.SESSION=$sessionToken" --data '{"name":"Products, Average of Price and Average of Rating, Grouped by Category and Vendor and Created At (month)","dataset_query":{"type":"query","query":{"source-table":5,"aggregation":[["avg",["field",60,null]],["avg",["field",65,null]]],"breakout":[["field",63,null],["field",62,null],["field",59,{"temporal-unit":"month"}]]},"database":2},"display":"scatter","description":null,"visualization_settings":{"scatter.bubble":"avg","graph.dimensions":["CREATED_AT"],"graph.metrics":["avg_2"]},"collection_id":null,"result_metadata":[{"description":"The type of product, valid values include: Doohicky, Gadget, Gizmo and Widget","semantic_type":"type/Category","coercion_strategy":null,"name":"CATEGORY","settings":null,"field_ref":["field",63,null],"effective_type":"type/Text","id":63,"display_name":"Category","fingerprint":{"global":{"distinct-count":4,"nil%":0},"type":{"type/Text":{"percent-json":0,"percent-url":0,"percent-email":0,"percent-state":0,"average-length":6.375}}},"base_type":"type/Text"},{"description":"The source of the product.","semantic_type":"type/Company","coercion_strategy":null,"name":"VENDOR","settings":null,"field_ref":["field",62,null],"effective_type":"type/Text","id":62,"display_name":"Vendor","fingerprint":{"global":{"distinct-count":200,"nil%":0},"type":{"type/Text":{"percent-json":0,"percent-url":0,"percent-email":0,"percent-state":0,"average-length":20.6}}},"base_type":"type/Text"},{"description":"The date the product was added to our catalog.","semantic_type":"type/CreationTimestamp","coercion_strategy":null,"unit":"month","name":"CREATED_AT","settings":null,"field_ref":["field",59,{"temporal-unit":"month"}],"effective_type":"type/Date","id":59,"display_name":"Created At","fingerprint":{"global":{"distinct-count":200,"nil%":0},"type":{"type/DateTime":{"earliest":"2016-04-26T19:29:55Z","latest":"2019-04-15T13:34:19Z"}}},"base_type":"type/Date"},{"display_name":"Average of Price","semantic_type":null,"settings":null,"field_ref":["aggregation",0],"name":"avg","base_type":"type/Float","effective_type":"type/Float","fingerprint":{"global":{"distinct-count":170,"nil%":0},"type":{"type/Number":{"min":15.691943673970439,"q1":37.25154462926434,"q3":75.4101708149213,"max":98.81933684368194,"sd":21.71141903667049,"avg":55.74639966792074}}}},{"display_name":"Average of Rating","semantic_type":"type/Score","settings":null,"field_ref":["aggregation",1],"name":"avg_2","base_type":"type/Float","effective_type":"type/Float","fingerprint":{"global":{"distinct-count":23,"nil%":0},"type":{"type/Number":{"min":0,"q1":3.5120465053408525,"q3":4.216124969497314,"max":5,"sd":1.3605488657451452,"avg":3.4715}}}}]}' && \
curl -s -X POST http://$1/api/card -H 'Content-Type: application/json' --cookie "metabase.SESSION=$sessionToken" --data '{"name":"Products, Average of Price and Average of Rating, Grouped by Category and Vendor and Created At (month)","cache_ttl":null,"dataset":false,"dataset_query":{"type":"query","query":{"source-table":5,"aggregation":[["avg",["field",60,null]],["avg",["field",65,null]]],"breakout":[["field",63,null],["field",62,null],["field",59,{"temporal-unit":"month"}]]},"database":2},"display":"pivot","description":null,"visualization_settings":{"scatter.bubble":"avg","graph.dimensions":["CREATED_AT"],"graph.metrics":["avg_2"],"pivot_table.column_split":{"rows":[["field",62,null],["field",59,{"temporal-unit":"month"}]],"columns":[["field",63,null]],"values":[["aggregation",0],["aggregation",1]]}},"archived":false,"enable_embedding":false,"embedding_params":null,"collection_id":null,"collection_position":null,"result_metadata":[{"description":"The type of product, valid values include: Doohicky, Gadget, Gizmo and Widget","semantic_type":null,"coercion_strategy":null,"name":"pivot-grouping","settings":null,"field_ref":["expression","pivot-grouping"],"effective_type":"type/Text","id":63,"display_name":"pivot-grouping","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":7,"q1":7,"q3":7,"max":7,"sd":null,"avg":7}}},"base_type":"type/BigInteger"},{"description":"The source of the product.","semantic_type":null,"coercion_strategy":null,"name":"avg","settings":null,"field_ref":["aggregation",0],"effective_type":"type/Text","id":62,"display_name":"Average of Price","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":55.74639966792074,"q1":55.74639966792074,"q3":55.74639966792074,"max":55.74639966792074,"sd":null,"avg":55.74639966792074}}},"base_type":"type/Float"},{"description":"The date the product was added to our catalog.","semantic_type":"type/Score","coercion_strategy":null,"name":"avg_2","settings":null,"field_ref":["aggregation",1],"effective_type":"type/Date","id":59,"display_name":"Average of Rating","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":3.4715000000000007,"q1":3.4715000000000007,"q3":3.4715000000000007,"max":3.4715000000000007,"sd":null,"avg":3.4715000000000007}}},"base_type":"type/Float"}]}' && \
curl -s -X POST http://$1/api/card -H 'Content-Type: application/json' --cookie "metabase.SESSION=$sessionToken" --data '{"name":"Reviews, Distinct values of ,Body, Average of ,Rating, Cumulative count, and Standard deviation of Rating, Grouped by Created At (month)","dataset_query":{"database":2,"query":{"source-table":7,"aggregation":[["distinct",["field",68,null]],["avg",["field",69,null]],["cum-count"],["stddev",["field",69,null]]],"breakout":[["field",67,{"temporal-unit":"month"}]]},"type":"query"},"display":"line","description":null,"visualization_settings":{"graph.dimensions":["CREATED_AT"],"graph.metrics":["count","avg","count_2","stddev"]},"collection_id":null,"result_metadata":[{"description":"The day and time a review was written by a user.","semantic_type":"type/CreationTimestamp","coercion_strategy":null,"unit":"month","name":"CREATED_AT","settings":null,"field_ref":["field",67,{"temporal-unit":"month"}],"effective_type":"type/Date","id":67,"display_name":"Created At","fingerprint":{"global":{"distinct-count":1112,"nil%":0},"type":{"type/DateTime":{"earliest":"2016-06-03T00:37:05Z","latest":"2020-04-19T14:15:25Z"}}},"base_type":"type/Date"},{"display_name":"Distinct values of Body","semantic_type":"type/Quantity","settings":null,"field_ref":["aggregation",0],"name":"count","base_type":"type/BigInteger","effective_type":"type/BigInteger","fingerprint":{"global":{"distinct-count":32,"nil%":0},"type":{"type/Number":{"min":1,"q1":9.738612787525831,"q3":35.625,"max":50,"sd":14.325830419430856,"avg":23.659574468085108}}}},{"display_name":"Average of Rating","semantic_type":"type/Score","settings":null,"field_ref":["aggregation",1],"name":"avg","base_type":"type/Decimal","effective_type":"type/Decimal","fingerprint":{"global":{"distinct-count":43,"nil%":0},"type":{"type/Number":{"min":3.1111,"q1":3.81365,"q3":4.206458565330651,"max":5,"sd":0.3303988095449969,"avg":4.006472340425532}}}},{"display_name":"Count","semantic_type":"type/Quantity","field_ref":["aggregation",2],"name":"count_2","base_type":"type/BigInteger","effective_type":"type/BigInteger","fingerprint":{"global":{"distinct-count":47,"nil%":0},"type":{"type/Number":{"min":4,"q1":65,"q3":676.25,"max":1112,"sd":355.57598515801317,"avg":391.74468085106383}}}},{"display_name":"SD of Rating","semantic_type":"type/Score","settings":null,"field_ref":["aggregation",3],"name":"stddev","base_type":"type/Float","effective_type":"type/Float","fingerprint":{"global":{"distinct-count":45,"nil%":0},"type":{"type/Number":{"min":0,"q1":0.777225,"q3":1.1451,"max":1.4524,"sd":0.31838423936501736,"avg":0.9279297872340423}}}}]}' && \
curl -s -X POST http://$1/api/card -H 'Content-Type: application/json' --cookie "metabase.SESSION=$sessionToken" --data '{"name":"Products, Standard deviation of ,Price, Standard deviation of ,Rating, Cumulative sum of ,Price, Cumulative count, Minimum of ,Rating, and Maximum of Rating, Grouped by Title and Vendor and Ean and Category","dataset_query":{"type":"query","query":{"source-table":5,"aggregation":[["stddev",["field",60,null]],["stddev",["field",65,null]],["cum-sum",["field",60,null]],["cum-count"],["min",["field",65,null]],["max",["field",65,null]]],"breakout":[["field",64,null],["field",62,null],["field",61,null],["field",63,null]]},"database":2},"display":"pivot","description":null,"visualization_settings":{"pivot_table.column_split":{"rows":[["field",62,null],["field",61,null]],"columns":[["field",63,null],["field",64,null]],"values":[["aggregation",0],["aggregation",1],["aggregation",2],["aggregation",3],["aggregation",4],["aggregation",5]]}},"collection_id":null,"result_metadata":[{"description":"The name of the product as it should be displayed to customers.","semantic_type":null,"coercion_strategy":null,"name":"pivot-grouping","settings":null,"field_ref":["expression","pivot-grouping"],"effective_type":"type/Text","id":64,"display_name":"pivot-grouping","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":15,"q1":15,"q3":15,"max":15,"sd":null,"avg":15}}},"base_type":"type/BigInteger"},{"description":"The source of the product.","semantic_type":null,"coercion_strategy":null,"name":"stddev","settings":null,"field_ref":["aggregation",0],"effective_type":"type/Text","id":62,"display_name":"SD of Price","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":21.658191559328987,"q1":21.658191559328987,"q3":21.658191559328987,"max":21.658191559328987,"sd":null,"avg":21.658191559328987}}},"base_type":"type/Float"},{"description":"The international article number. A 13 digit number uniquely identifying the product.","semantic_type":"type/Score","coercion_strategy":null,"name":"stddev_2","settings":null,"field_ref":["aggregation",1],"effective_type":"type/Text","id":61,"display_name":"SD of Rating","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":1.3571432312029559,"q1":1.3571432312029559,"q3":1.3571432312029559,"max":1.3571432312029559,"sd":null,"avg":1.3571432312029559}}},"base_type":"type/Float"},{"description":"The type of product, valid values include: Doohicky, Gadget, Gizmo and Widget","semantic_type":null,"coercion_strategy":null,"name":"sum","settings":null,"field_ref":["aggregation",2],"effective_type":"type/Text","id":63,"display_name":"Sum of Price","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":11149.279933584148,"q1":11149.279933584148,"q3":11149.279933584148,"max":11149.279933584148,"sd":null,"avg":11149.279933584148}}},"base_type":"type/Float"},{"display_name":"Count","field_ref":["aggregation",3],"name":"count","base_type":"type/BigInteger","effective_type":"type/BigInteger","semantic_type":"type/Quantity","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":200,"q1":200,"q3":200,"max":200,"sd":null,"avg":200}}}},{"display_name":"Min of Rating","semantic_type":"type/Score","settings":null,"field_ref":["aggregation",4],"name":"min","base_type":"type/Float","effective_type":"type/Float","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":0,"q1":0,"q3":0,"max":0,"sd":null,"avg":0}}}},{"display_name":"Max of Rating","semantic_type":"type/Score","settings":null,"field_ref":["aggregation",5],"name":"max","base_type":"type/Float","effective_type":"type/Float","fingerprint":{"global":{"distinct-count":1,"nil%":0},"type":{"type/Number":{"min":5,"q1":5,"q3":5,"max":5,"sd":null,"avg":5}}}}]}'; fi